version: 1
applications:
  - appRoot: apps/web
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci --prefix ../..
        build:
          commands:
            # Create .env file for runtime (values not logged)
            - |
              cat <<EOF > .env.local
              PLAID_CLIENT_ID=${PLAID_CLIENT_ID}
              PLAID_SECRET=${PLAID_SECRET}
              PLAID_ENV=${PLAID_ENV}
              SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
              STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
              STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
              STRIPE_PRO_MONTHLY_PRICE_ID=${STRIPE_PRO_MONTHLY_PRICE_ID}
              STRIPE_PRO_YEARLY_PRICE_ID=${STRIPE_PRO_YEARLY_PRICE_ID}
              ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
              NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
              NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
              NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
              NEXT_PUBLIC_STRIPE_PRO_MONTHLY_PRICE_ID=${NEXT_PUBLIC_STRIPE_PRO_MONTHLY_PRICE_ID}
              NEXT_PUBLIC_STRIPE_PRO_YEARLY_PRICE_ID=${NEXT_PUBLIC_STRIPE_PRO_YEARLY_PRICE_ID}
              NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
              EOF
            - npm run build --prefix ../..
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - ../../node_modules/**/*
          - .next/cache/**/*
