version: 1
applications:
  - appRoot: apps/web
    frontend:
      phases:
        preBuild:
          commands:
            - echo "=== Cleaning previous build artifacts ==="
            - rm -rf .next
            - rm -rf amplify-compute-bundle-output
            - npm ci --prefix ../..
        build:
          commands:
            - echo "=== Checking environment variables ==="
            - echo "PLAID_CLIENT_ID is set:" && test -n "$PLAID_CLIENT_ID" && echo "YES" || echo "NO"
            - echo "PLAID_SECRET is set:" && test -n "$PLAID_SECRET" && echo "YES" || echo "NO"
            - echo "PLAID_ENV=$PLAID_ENV"
            - printenv | grep -E "^(PLAID_|SUPABASE_|STRIPE_|ANTHROPIC_|NEXT_PUBLIC_)" > .env.production
            - echo "=== Created .env.production with $(wc -l < .env.production) variables ==="
            - cat .env.production | sed 's/=.*/=***MASKED***/'
            - echo "=== Building Next.js ==="
            - npm run build --prefix ../..
            - echo "=== Copying env file to standalone ==="
            - cp .env.production .next/standalone/finance-ai/apps/web/ 2>/dev/null || echo "No standalone web dir"
            - cp .env.production .next/standalone/finance-ai/apps/web/.next/ 2>/dev/null || echo "No standalone .next"
            - cp .env.production .next/standalone/finance-ai/ 2>/dev/null || echo "No standalone root"
            - echo "=== Standalone structure ==="
            - ls -la .next/standalone/finance-ai/apps/web/ 2>/dev/null || echo "No standalone web dir"
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - ../../node_modules/**/*
          # Removed .next/cache to prevent stale file conflicts during bundling
